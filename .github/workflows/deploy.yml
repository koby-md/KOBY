name: Deploy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 */6 * * *"  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      actions: write

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Install Node.js 20
        run: |
          curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install 20
          nvm use 20
          node -v

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ------------------------------------------------------------------
      #   Ø§Ù„Ø­Ù„ Ù„Ø®Ø·Ø£ ENOENT
      # ------------------------------------------------------------------
      - name: Clean Up Credentials (Fix ENOENT) ðŸ§¹
        run: rm -f MyStaticSession/creds.json

      - name: Fix apt sources (to avoid broken mirrors)
        run: |
          sudo sed -i 's|mirror+file:/etc/apt/apt-mirrors.txt|http://archive.ubuntu.com/ubuntu|' /etc/apt/sources.list
          sudo apt update

      - name: Install System Dependencies (for sharp and ffmpeg)
        run: |
          sudo apt install -y libvips-dev ffmpeg

      - name: Install Node.js Dependencies
        run: npm install

      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}

      # ------------------------------------------------------------------
      #   Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© EPIPE / SIGTERM
      # ------------------------------------------------------------------
      - name: Start Project (Fix EPIPE/SIGTERM requirement) ðŸš€
        run: |
          echo "ðŸ› ï¸ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¢Ù…Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª..."
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø­Ù…Ø§ÙŠØ© Ù…Ø¤Ù‚Øª Ù„Ù…Ù†Ø¹ ØªÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯ SIGTERM Ø£Ùˆ EPIPE
          echo "
          process.on('SIGTERM', () => {
            console.log('âš ï¸ ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ SIGTERM â€” ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø¨Ø£Ù…Ø§Ù†...');
            process.exit(0);
          });
          process.on('SIGPIPE', () => {
            console.warn('âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¥Ø´Ø§Ø±Ø© SIGPIPE (Ø£Ù†Ø¨ÙˆØ¨ Ù…ØºÙ„Ù‚)');
          });
          process.on('uncaughtException', err => {
            console.error('[âŒ uncaughtException]', err);
          });
          process.on('unhandledRejection', err => {
            console.error('[âŒ unhandledRejection]', err);
          });
          import('./index.js');
          " > safe-runner.mjs

          echo "ðŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ù…Ù† SIGTERM/EPIPE..."
          node safe-runner.mjs